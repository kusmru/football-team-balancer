<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Team Balancer Pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.5;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .player-list, .team-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .player-card {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
            position: relative;
            width: 140px;
        }
        .player-card.selected {
            background-color: #e0e0e0;
        }
        .player-card.goalkeeper {
            background-color: #ffecb3;
        }
        .player-card.high-attendance {
            border-left: 4px solid #4caf50;
        }
        .player-card.low-attendance {
            border-left: 4px solid #f44336;
        }
        .team {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            flex: 1;
            min-width: 200px;
            background-color: #f5f5f5;
        }
        .team-a {
            background-color: #e3f2fd;
        }
        .team-b {
            background-color: #ffebee;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 8px 15px;
            margin-right: 10px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f8f8;
        }
        .form div {
            margin-bottom: 10px;
        }
        .stats {
            margin-top: 10px;
            font-weight: bold;
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            color: red;
            font-size: 16px;
        }
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .team-title {
            margin: 0;
        }
        .player-section {
            margin-top: 10px;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        input, select {
            padding: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        .search-box {
            margin-bottom: 15px;
        }
        .instructions {
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .sort-controls {
            margin-bottom: 15px;
        }
        .attendance-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .high-attendance {
            background-color: #4caf50;
        }
        .medium-attendance {
            background-color: #ff9800;
        }
        .low-attendance {
            background-color: #f44336;
        }
        .match-history {
            margin-top: 20px;
        }
        .match-item {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .score {
            font-weight: bold;
            font-size: 1.2em;
        }
        .captain-picker {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f8f8;
        }
        .captain-selection {
            margin-top: 15px;
        }
        .turn-indicator {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2196f3;
        }
        .goal-tracker {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
        }
        .goal-item {
            margin: 5px 0;
            padding: 5px;
            background-color: #f8f8f8;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .incremental-btn {
            width: 24px;
            height: 24px;
            padding: 0;
            margin: 0;
            line-height: 1;
            border-radius: 12px;
        }
        .comparison-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .comparison-card {
            display: flex;
            width: 100%;
            max-width: 800px;
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-compare {
            flex: 1;
            text-align: center;
            padding: 15px;
            margin: 0 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .player-compare.left {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .player-compare.right {
            background-color: #ffebee;
            border-color: #f44336;
        }
        .player-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .player-stats {
            text-align: left;
            margin: 10px 0;
        }
        .comparison-buttons {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 15px;
        }
        .comparison-buttons button {
            margin: 5px 0;
            padding: 10px 15px;
        }
        .empty-comparison {
            text-align: center;
            padding: 40px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px dashed #ccc;
        }
        .elo-explanation {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .invitation-system {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f8f8;
        }
        .invitation-system textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .invitation-system .note {
            font-size: 0.8em;
            font-style: italic;
            color: #666;
            margin-top: 10px;
        }
        .invitation-system button {
            margin-top: 10px;
        }
        #inviteeList {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .invitee {
            padding: 5px;
            margin-bottom: 5px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Football Team Balancer Pro</h1>
    
    <div class="tabs">
        <div class="tab active" data-tab="players">Players</div>
        <div class="tab" data-tab="game">Game Day</div>
        <div class="tab" data-tab="matches">Match History</div>
        <div class="tab" data-tab="stats">Statistics</div>
        <div class="tab" data-tab="compare">Compare Players</div>
    </div>
    
    <!-- PLAYERS TAB -->
    <div class="tab-content active" id="players-tab">
        <div class="instructions">
            <p><strong>Player Management:</strong> Add all your regular players with their skill ratings. Players with higher attendance are more likely to be invited to games.</p>
        </div>
        
        <div class="form">
            <h2>Add Player</h2>
            <div>
                <label for="playerName">Name:</label>
                <input type="text" id="playerName">
            </div>
            <div>
                <label for="playerRating">Skill Rating (1-10):</label>
                <input type="number" id="playerRating" min="1" max="10" value="5">
            </div>
            <div>
                <label for="playerPosition">Primary Position:</label>
                <select id="playerPosition">
                    <option value="field">Field Player</option>
                    <option value="goalkeeper">Goalkeeper</option>
                    <option value="both">Both</option>
                </select>
            </div>
            <button id="addPlayer">Add Player</button>
        </div>

        <div class="search-box">
            <input type="text" id="searchPlayers" placeholder="Search players...">
        </div>
        
        <div class="sort-controls">
            <label>Sort by: </label>
            <select id="sortPlayers">
                <option value="name">Name</option>
                <option value="rating">Rating (High to Low)</option>
                <option value="attendance">Attendance (High to Low)</option>
            </select>
        </div>
        
        <h2>Player Database (<span id="playerCount">0</span>)</h2>
        <div class="player-list" id="playerList"></div>
        
        <div class="controls">
            <button id="saveToFile">Export Player Database</button>
            <button id="loadFromFile">Import Player Database</button>
            <input type="file" id="fileInput" style="display: none">
        </div>
    </div>
    
    <!-- GAME DAY TAB -->
    <div class="tab-content" id="game-tab">
        <div class="instructions">
            <p><strong>Game Day:</strong> Select today's available players and either balance teams automatically or use the captain pick simulation.</p>
        </div>
        
        <div class="invitation-system">
            <h3>Send Invitations</h3>
            <div class="form">
                <div>
                    <label for="invitationMessage">Message:</label>
                    <textarea id="invitationMessage" rows="3">Football game this Saturday at 6pm. Can you play? Reply YES or NO.</textarea>
                </div>
                <div>
                    <label>Number of players needed:</label>
                    <input type="number" id="playersNeeded" min="4" max="22" value="14">
                </div>
                <div>
                    <label>Prioritize by:</label>
                    <select id="invitePriority">
                        <option value="attendance">Attendance (most games first)</option>
                        <option value="rating">Skill Rating (highest first)</option>
                        <option value="hybrid">Hybrid (60% attendance, 40% rating)</option>
                    </select>
                </div>
                <button id="sendInvites">🔄 Simulate SMS Invites</button>
                <p class="note">Note: This is a simulation. Connect to Twilio or another SMS service for actual message delivery.</p>
            </div>
            <div id="invitationResults" style="display: none;">
                <h4>Invitation Results</h4>
                <div id="inviteeList"></div>
            </div>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchGamePlayers" placeholder="Search players...">
        </div>
        
        <h2>Select Available Players</h2>
        <div class="player-list" id="availablePlayerList"></div>
        
        <div class="controls">
            <button id="selectAll">Select All</button>
            <button id="clearSelection">Clear Selection</button>
            <button id="balanceTeams">Balance Teams Automatically</button>
            <button id="captainMode">Captain Pick Mode</button>
            <button id="resetTeams">Reset Teams</button>
        </div>
        
        <div class="captain-picker" id="captainPicker" style="display: none;">
            <h3>Captain Pick Mode</h3>
            <div>
                <label>Captain Team A: </label>
                <select id="captainA"></select>
            </div>
            <div>
                <label>Captain Team B: </label>
                <select id="captainB"></select>
            </div>
            <button id="startPicking">Start Picking</button>
            
            <div class="captain-selection" id="captainSelection" style="display: none;">
                <div class="turn-indicator" id="turnIndicator">Team A Captain's Turn</div>
                <div class="player-list" id="pickablePlayerList"></div>
            </div>
        </div>
        
        <h2>Teams</h2>
        <div class="team-container">
            <div class="team team-a" id="teamA">
                <div class="team-header">
                    <h3 class="team-title">Team A</h3>
                    <div>
                        <label for="teamAScore">Score: </label>
                        <input type="number" id="teamAScore" min="0" value="0" style="width: 60px;">
                    </div>
                </div>
                <div class="player-section">
                    <div class="section-title">Starting Players</div>
                    <div id="teamAStarters"></div>
                </div>
                <div class="player-section">
                    <div class="section-title">Reserves</div>
                    <div id="teamAReserves"></div>
                </div>
                <div class="stats" id="teamAStats"></div>
                
                <!-- Add goal tracking section -->
                <div class="goal-tracker">
                    <h4>Goals</h4>
                    <div id="teamAGoals"></div>
                    <div style="margin-top: 10px;">
                        <select id="teamAScorer" style="width: 45%;">
                            <option value="">Goal scorer...</option>
                        </select>
                        <select id="teamAAssist" style="width: 45%;">
                            <option value="">Assist (optional)...</option>
                        </select>
                        <button onclick="addGoal('A')">Add Goal</button>
                    </div>
                </div>
            </div>
            <div class="team team-b" id="teamB">
                <div class="team-header">
                    <h3 class="team-title">Team B</h3>
                    <div>
                        <label for="teamBScore">Score: </label>
                        <input type="number" id="teamBScore" min="0" value="0" style="width: 60px;">
                    </div>
                </div>
                <div class="player-section">
                    <div class="section-title">Starting Players</div>
                    <div id="teamBStarters"></div>
                </div>
                <div class="player-section">
                    <div class="section-title">Reserves</div>
                    <div id="teamBReserves"></div>
                </div>
                <div class="stats" id="teamBStats"></div>
                
                <!-- Add goal tracking section -->
                <div class="goal-tracker">
                    <h4>Goals</h4>
                    <div id="teamBGoals"></div>
                    <div style="margin-top: 10px;">
                        <select id="teamBScorer" style="width: 45%;">
                            <option value="">Goal scorer...</option>
                        </select>
                        <select id="teamBAssist" style="width: 45%;">
                            <option value="">Assist (optional)...</option>
                        </select>
                        <button onclick="addGoal('B')">Add Goal</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="recordMatch">Record Match Result</button>
        </div>
    </div>
    
    <!-- MATCH HISTORY TAB -->
    <div class="tab-content" id="matches-tab">
        <h2>Match History</h2>
        <div id="matchHistory" class="match-history"></div>
    </div>
    
    <!-- STATISTICS TAB -->
    <div class="tab-content" id="stats-tab">
        <h2>Player Statistics</h2>
        <div class="search-box">
            <input type="text" id="searchStatsPlayers" placeholder="Search players...">
        </div>
        <div id="playerStats"></div>
    </div>

    <!-- Add this new tab content section after the Stats tab -->
    <div class="tab-content" id="compare-tab">
        <h2>Player Comparison System</h2>
        
        <div class="instructions">
            <p><strong>Player Comparison:</strong> This system helps you objectively rate players by directly comparing their performances. Simply select who played better, and the system will automatically adjust ratings using an Elo algorithm.</p>
        </div>
        
        <div class="comparison-container" id="comparisonContainer">
            <div class="empty-comparison">
                <p>Click the button below to start comparing players.</p>
            </div>
        </div>
        
        <div class="controls">
            <button id="generateComparison">Compare Random Players</button>
            <button id="compareAfterMatch">Compare Players from Last Match</button>
        </div>
        
        <div class="elo-explanation">
            <h3>How the Rating System Works</h3>
            <p>The system uses an Elo algorithm (similar to chess ratings) to objectively rate players:</p>
            <ul>
                <li>When a higher-rated player wins a comparison, their rating increases slightly</li>
                <li>When a lower-rated player wins a comparison, their rating increases significantly</li>
                <li>The losing player's rating decreases by the same amount</li>
                <li>Multiple comparisons over time lead to more accurate ratings</li>
            </ul>
        </div>
    </div>

    <script>
        // Data structures
        let allPlayers = JSON.parse(localStorage.getItem('footballPlayers')) || [];
        let matchHistory = JSON.parse(localStorage.getItem('matchHistory')) || [];
        let selectedPlayers = [];
        let teamA = {
            starters: [],
            reserves: [],
            captain: null,
            goals: []
        };
        let teamB = {
            starters: [],
            reserves: [],
            captain: null,
            goals: []
        };
        let captainMode = false;
        let currentTeamTurn = 'A';
        let unpickedPlayers = [];
        
        // DOM elements - Tabs
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // DOM elements - Players
        const playerListEl = document.getElementById('playerList');
        const searchEl = document.getElementById('searchPlayers');
        const sortEl = document.getElementById('sortPlayers');
        const playerCountEl = document.getElementById('playerCount');
        const fileInputEl = document.getElementById('fileInput');
        
        // DOM elements - Game Day
        const availablePlayerListEl = document.getElementById('availablePlayerList');
        const searchGameEl = document.getElementById('searchGamePlayers');
        const teamAStartersEl = document.getElementById('teamAStarters');
        const teamBStartersEl = document.getElementById('teamBStarters');
        const teamAReservesEl = document.getElementById('teamAReserves');
        const teamBReservesEl = document.getElementById('teamBReserves');
        const teamAStatsEl = document.getElementById('teamAStats');
        const teamBStatsEl = document.getElementById('teamBStats');
        const captainPickerEl = document.getElementById('captainPicker');
        const captainSelectionEl = document.getElementById('captainSelection');
        const captainAEl = document.getElementById('captainA');
        const captainBEl = document.getElementById('captainB');
        const turnIndicatorEl = document.getElementById('turnIndicator');
        const pickablePlayerListEl = document.getElementById('pickablePlayerList');
        
        // DOM elements - Match History
        const matchHistoryEl = document.getElementById('matchHistory');
        
        // DOM elements - Statistics
        const playerStatsEl = document.getElementById('playerStats');
        const searchStatsEl = document.getElementById('searchStatsPlayers');
        
        // DOM elements - Compare
        const comparisonContainerEl = document.getElementById('comparisonContainer');
        
        // Initialize
        renderPlayerList();
        renderMatchHistory();
        updatePlayerCount();
        
        // Tab Navigation
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                
                // Refresh tab content when switching
                if(tab.dataset.tab === 'game') {
                    renderAvailablePlayers();
                } else if(tab.dataset.tab === 'matches') {
                    renderMatchHistory();
                } else if(tab.dataset.tab === 'stats') {
                    renderPlayerStats();
                } else if(tab.dataset.tab === 'compare') {
                    renderComparison();
                }
            });
        });
        
        // Event Listeners - Players Tab
        document.getElementById('addPlayer').addEventListener('click', addPlayer);
        document.getElementById('saveToFile').addEventListener('click', saveToFile);
        document.getElementById('loadFromFile').addEventListener('click', () => fileInputEl.click());
        fileInputEl.addEventListener('change', loadFromFile);
        searchEl.addEventListener('input', () => renderPlayerList());
        sortEl.addEventListener('change', () => renderPlayerList());
        
        // Event Listeners - Game Day Tab
        document.getElementById('selectAll').addEventListener('click', selectAllPlayers);
        document.getElementById('clearSelection').addEventListener('click', clearSelection);
        document.getElementById('balanceTeams').addEventListener('click', balanceTeams);
        document.getElementById('captainMode').addEventListener('click', toggleCaptainMode);
        document.getElementById('resetTeams').addEventListener('click', resetTeams);
        document.getElementById('startPicking').addEventListener('click', startCaptainPicking);
        document.getElementById('recordMatch').addEventListener('click', recordMatch);
        searchGameEl.addEventListener('input', () => renderAvailablePlayers());
        
        // Event Listeners - Statistics Tab
        searchStatsEl.addEventListener('input', () => renderPlayerStats());
        
        // Event Listeners - Compare
        document.getElementById('generateComparison').addEventListener('click', generateRandomComparison);
        document.getElementById('compareAfterMatch').addEventListener('click', compareLastMatchPlayers);
        
        // Event Listeners - Game Day
        document.getElementById('sendInvites').addEventListener('click', simulateSendInvites);
        
        // Functions - Player Management
        function addPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const rating = parseInt(document.getElementById('playerRating').value);
            const position = document.getElementById('playerPosition').value;
            
            if (!name) return alert('Please enter a player name');
            
            const player = {
                id: Date.now(),
                name: name,
                rating: rating,
                position: position,
                attendance: 0,
                matches: 0,
                wins: 0,
                losses: 0,
                draws: 0,
                goals: 0,
                assists: 0
            };
            
            allPlayers.push(player);
            savePlayersToStorage();
            renderPlayerList();
            updatePlayerCount();
            
            // Clear form
            document.getElementById('playerName').value = '';
            document.getElementById('playerRating').value = 5;
            document.getElementById('playerPosition').value = 'field';
        }
        
        function renderPlayerList() {
            playerListEl.innerHTML = '';
            
            const searchTerm = searchEl.value.toLowerCase();
            let filteredPlayers = allPlayers.filter(p => 
                p.name.toLowerCase().includes(searchTerm)
            );
            
            // Sort players
            const sortBy = sortEl.value;
            if (sortBy === 'name') {
                filteredPlayers.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'rating') {
                filteredPlayers.sort((a, b) => b.rating - a.rating);
            } else if (sortBy === 'attendance') {
                filteredPlayers.sort((a, b) => b.attendance - a.attendance);
            }
            
            filteredPlayers.forEach(player => {
                const playerCard = document.createElement('div');
                const isGoalkeeper = player.position === 'goalkeeper' || player.position === 'both';
                
                let attendanceClass = '';
                if (player.attendance >= 10) {
                    attendanceClass = ' high-attendance';
                } else if (player.attendance <= 3 && player.attendance > 0) {
                    attendanceClass = ' low-attendance';
                }
                
                playerCard.className = `player-card${isGoalkeeper ? ' goalkeeper' : ''}${attendanceClass}`;
                playerCard.innerHTML = `
                    <span class="delete-btn" data-id="${player.id}">×</span>
                    <strong>${player.name}</strong> 
                    <br>Rating: ${player.rating}/10
                    <br>Position: ${formatPosition(player.position)}
                    <br>Attendance: ${player.attendance} games
                `;
                
                // Delete button
                const deleteBtn = playerCard.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deletePlayer(player.id);
                });
                
                playerListEl.appendChild(playerCard);
            });
        }
        
        function deletePlayer(id) {
            if (confirm('Are you sure you want to delete this player?')) {
                allPlayers = allPlayers.filter(p => p.id !== id);
                selectedPlayers = selectedPlayers.filter(p => p.id !== id);
                savePlayersToStorage();
                renderPlayerList();
                renderAvailablePlayers();
                renderTeams();
                updatePlayerCount();
            }
        }
        
        // Functions - Game Day
        function renderAvailablePlayers() {
            availablePlayerListEl.innerHTML = '';
            
            const searchTerm = searchGameEl.value.toLowerCase();
            const filteredPlayers = allPlayers.filter(p => 
                p.name.toLowerCase().includes(searchTerm)
            ).sort((a, b) => b.attendance - a.attendance);
            
            filteredPlayers.forEach(player => {
                const playerCard = document.createElement('div');
                const isGoalkeeper = player.position === 'goalkeeper' || player.position === 'both';
                const isSelected = selectedPlayers.some(p => p.id === player.id);
                
                let attendanceClass = '';
                if (player.attendance >= 10) {
                    attendanceClass = ' high-attendance';
                } else if (player.attendance <= 3 && player.attendance > 0) {
                    attendanceClass = ' low-attendance';
                }
                
                playerCard.className = `player-card${isGoalkeeper ? ' goalkeeper' : ''}${isSelected ? ' selected' : ''}${attendanceClass}`;
                playerCard.innerHTML = `
                    <strong>${player.name}</strong> 
                    <br>Rating: ${player.rating}/10
                    <br>Position: ${formatPosition(player.position)}
                    <br>Attendance: ${player.attendance} games
                `;
                
                playerCard.addEventListener('click', () => togglePlayerSelection(player));
                availablePlayerListEl.appendChild(playerCard);
            });
        }
        
        function togglePlayerSelection(player) {
            const index = selectedPlayers.findIndex(p => p.id === player.id);
            
            if (index === -1) {
                selectedPlayers.push(player);
            } else {
                selectedPlayers.splice(index, 1);
            }
            
            renderAvailablePlayers();
            updateCaptainSelects();
        }
        
        function selectAllPlayers() {
            selectedPlayers = [...allPlayers];
            renderAvailablePlayers();
            updateCaptainSelects();
        }
        
        function clearSelection() {
            selectedPlayers = [];
            renderAvailablePlayers();
            updateCaptainSelects();
        }
        
        function updateCaptainSelects() {
            // Update captain dropdowns
            captainAEl.innerHTML = '<option value="">Select Captain</option>';
            captainBEl.innerHTML = '<option value="">Select Captain</option>';
            
            selectedPlayers.forEach(player => {
                const optionA = document.createElement('option');
                optionA.value = player.id;
                optionA.textContent = player.name;
                captainAEl.appendChild(optionA);
                
                const optionB = document.createElement('option');
                optionB.value = player.id;
                optionB.textContent = player.name;
                captainBEl.appendChild(optionB);
            });
        }
        
        function toggleCaptainMode() {
            if (selectedPlayers.length < 6) {
                return alert('Please select at least 6 players');
            }
            
            captainMode = true;
            captainPickerEl.style.display = 'block';
            updateCaptainSelects();
        }
        
        function startCaptainPicking() {
            const captainAId = captainAEl.value;
            const captainBId = captainBEl.value;
            
            if (!captainAId || !captainBId) {
                return alert('Please select captains for both teams');
            }
            
            if (captainAId === captainBId) {
                return alert('Please select different captains for each team');
            }
            
            // Reset teams
            teamA = {
                starters: [],
                reserves: [],
                captain: null,
                goals: []
            };
            
            teamB = {
                starters: [],
                reserves: [],
                captain: null,
                goals: []
            };
            
            // Set captains
            const captainA = selectedPlayers.find(p => p.id.toString() === captainAId);
            const captainB = selectedPlayers.find(p => p.id.toString() === captainBId);
            
            teamA.starters.push(captainA);
            teamA.captain = captainA;
            
            teamB.starters.push(captainB);
            teamB.captain = captainB;
            
            // Start picking
            currentTeamTurn = 'A'; // Team A starts
            unpickedPlayers = selectedPlayers.filter(p => 
                p.id !== captainA.id && p.id !== captainB.id
            );
            
            captainSelectionEl.style.display = 'block';
            updateTurnIndicator();
            renderPickablePlayers();
            renderTeams();
        }
        
        function updateTurnIndicator() {
            const currentCaptain = currentTeamTurn === 'A' ? teamA.captain.name : teamB.captain.name;
            turnIndicatorEl.textContent = `Team ${currentTeamTurn} Captain's Turn (${currentCaptain})`;
        }
        
        function renderPickablePlayers() {
            pickablePlayerListEl.innerHTML = '';
            
            unpickedPlayers.forEach(player => {
                const playerCard = document.createElement('div');
                const isGoalkeeper = player.position === 'goalkeeper' || player.position === 'both';
                
                let attendanceClass = '';
                if (player.attendance >= 10) {
                    attendanceClass = ' high-attendance';
                } else if (player.attendance <= 3 && player.attendance > 0) {
                    attendanceClass = ' low-attendance';
                }
                
                playerCard.className = `player-card${isGoalkeeper ? ' goalkeeper' : ''}${attendanceClass}`;
                playerCard.innerHTML = `
                    <strong>${player.name}</strong> 
                    <br>Rating: ${player.rating}/10
                    <br>Position: ${formatPosition(player.position)}
                `;
                
                playerCard.addEventListener('click', () => pickPlayer(player));
                pickablePlayerListEl.appendChild(playerCard);
            });
        }
        
        function pickPlayer(player) {
            // Add to current team
            const currentTeam = currentTeamTurn === 'A' ? teamA : teamB;
            
            if (currentTeam.starters.length < 6) {
                currentTeam.starters.push(player);
            } else {
                currentTeam.reserves.push(player);
            }
            
            // Remove from unpicked
            unpickedPlayers = unpickedPlayers.filter(p => p.id !== player.id);
            
            // Switch turns
            currentTeamTurn = currentTeamTurn === 'A' ? 'B' : 'A';
            
            // Update UI
            updateTurnIndicator();
            renderPickablePlayers();
            renderTeams();
            
            // Check if picking is complete
            if (unpickedPlayers.length === 0) {
                alert('All players have been picked!');
                captainSelectionEl.style.display = 'none';
            }
        }
        
        function balanceTeams() {
            if (selectedPlayers.length < 6) {
                return alert('Please select at least 6 players (minimum for 3v3)');
            }
            
            // Reset teams
            teamA = {
                starters: [],
                reserves: [],
                captain: null,
                goals: []
            };
            
            teamB = {
                starters: [],
                reserves: [],
                captain: null,
                goals: []
            };
            
            // Sort by rating, highest first
            const sortedPlayers = [...selectedPlayers].sort((a, b) => b.rating - a.rating);
            
            // Separate goalkeepers
            const goalkeepers = sortedPlayers.filter(p => p.position === 'goalkeeper' || p.position === 'both');
            let fieldPlayers = sortedPlayers.filter(p => p.position === 'field' || (p.position === 'both' && goalkeepers.length > 2));
            
            // Add goalkeeper-capable players to fieldPlayers if not needed as goalkeepers
            if (goalkeepers.length > 2) {
                const excessKeepers = goalkeepers.slice(2);
                fieldPlayers = [...fieldPlayers, ...excessKeepers];
            }
            
            // Assign goalkeepers first, one to each team if available
            if (goalkeepers.length >= 2) {
                teamA.starters.push(goalkeepers[0]);
                teamB.starters.push(goalkeepers[1]);
            } else if (goalkeepers.length === 1) {
                teamA.starters.push(goalkeepers[0]);
                alert('Warning: Only one goalkeeper available. Team B will need an outfield player as goalkeeper.');
            } else {
                alert('Warning: No goalkeepers available. Both teams will need outfield players as goalkeepers.');
            }
            
            // Sort field players again by rating
            fieldPlayers.sort((a, b) => b.rating - a.rating);
            
            // Distribute field players using algorithm (alternating with team strength balancing)
            let teamAStrength = getTotalRating(teamA.starters);
            let teamBStrength = getTotalRating(teamB.starters);
            
            for (let i = 0; i < fieldPlayers.length; i++) {
                const player = fieldPlayers[i];
                
                // Determine which team gets the player based on current strength
                let targetTeam;
                if (teamAStrength < teamBStrength) {
                    targetTeam = teamA;
                    teamAStrength += player.rating;
                } else {
                    targetTeam = teamB;
                    teamBStrength += player.rating;
                }
                
                // Add to starters or reserves
                if (targetTeam.starters.length < 6) {
                    targetTeam.starters.push(player);
                } else {
                    targetTeam.reserves.push(player);
                }
            }
            
            captainMode = false;
            captainPickerEl.style.display = 'none';
            captainSelectionEl.style.display = 'none';
            renderTeams();
        }
        
        function renderTeams() {
            teamAStartersEl.innerHTML = '';
            teamBStartersEl.innerHTML = '';
            teamAReservesEl.innerHTML = '';
            teamBReservesEl.innerHTML = '';
            
            renderTeamPlayers(teamA.starters, teamAStartersEl);
            renderTeamPlayers(teamB.starters, teamBStartersEl);
            renderTeamPlayers(teamA.reserves, teamAReservesEl);
            renderTeamPlayers(teamB.reserves, teamBReservesEl);
            
            // Update team stats
            updateTeamStats();
            
            // Update goal selectors
            updateGoalSelectors();
            
            // Update goals display
            renderGoals();
        }
        
        function renderTeamPlayers(players, container) {
            players.forEach(player => {
                const playerCard = document.createElement('div');
                const isGoalkeeper = player.position === 'goalkeeper' || player.position === 'both';
                
                let attendanceClass = '';
                if (player.attendance >= 10) {
                    attendanceClass = ' high-attendance';
                } else if (player.attendance <= 3 && player.attendance > 0) {
                    attendanceClass = ' low-attendance';
                }
                
                playerCard.className = `player-card${isGoalkeeper ? ' goalkeeper' : ''}${attendanceClass}`;
                playerCard.innerHTML = `
                    <strong>${player.name}</strong> 
                    <br>Rating: ${player.rating}/10
                    <br>Position: ${formatPosition(player.position)}
                `;
                
                container.appendChild(playerCard);
            });
        }
        
        function updateTeamStats() {
            const teamARating = getTotalRating(teamA.starters) / (teamA.starters.length || 1);
            const teamBRating = getTotalRating(teamB.starters) / (teamB.starters.length || 1);
            
            teamAStatsEl.innerHTML = `
                <div>Average Rating: ${teamARating.toFixed(1)}</div>
                <div>Players: ${teamA.starters.length + teamA.reserves.length}</div>
            `;
            
            teamBStatsEl.innerHTML = `
                <div>Average Rating: ${teamBRating.toFixed(1)}</div>
                <div>Players: ${teamB.starters.length + teamB.reserves.length}</div>
            `;
        }
        
        function getTotalRating(players) {
            return players.reduce((sum, player) => sum + player.rating, 0);
        }
        
        function resetTeams() {
            teamA = {
                starters: [],
                reserves: [],
                captain: null,
                goals: []
            };
            
            teamB = {
                starters: [],
                reserves: [],
                captain: null,
                goals: []
            };
            
            captainMode = false;
            captainPickerEl.style.display = 'none';
            captainSelectionEl.style.display = 'none';
            
            document.getElementById('teamAScore').value = 0;
            document.getElementById('teamBScore').value = 0;
            
            renderTeams();
            renderGoals();
        }
        
        function addGoal(team) {
            const teamObj = team === 'A' ? teamA : teamB;
            const scorerSelect = document.getElementById(`team${team}Scorer`);
            const assistSelect = document.getElementById(`team${team}Assist`);
            
            const scorerId = scorerSelect.value;
            const assistId = assistSelect.value;
            
            if (!scorerId) {
                return alert('Please select a goal scorer');
            }
            
            const scorer = allPlayers.find(p => p.id.toString() === scorerId);
            const assist = assistId ? allPlayers.find(p => p.id.toString() === assistId) : null;
            
            const goal = {
                scorer: scorer.id,
                scorerName: scorer.name,
                assist: assist ? assist.id : null,
                assistName: assist ? assist.name : null,
                time: Date.now()
            };
            
            teamObj.goals.push(goal);
            
            // Update score input
            const scoreInput = document.getElementById(`team${team}Score`);
            scoreInput.value = parseInt(scoreInput.value || 0) + 1;
            
            // Update goals display
            renderGoals();
            
            // Reset selectors
            scorerSelect.value = '';
            assistSelect.value = '';
        }
        
        function renderGoals() {
            const teamAGoalsEl = document.getElementById('teamAGoals');
            const teamBGoalsEl = document.getElementById('teamBGoals');
            
            teamAGoalsEl.innerHTML = '';
            teamBGoalsEl.innerHTML = '';
            
            teamA.goals.forEach(goal => {
                const goalDiv = document.createElement('div');
                goalDiv.className = 'goal-item';
                goalDiv.innerHTML = 
                    `<strong>${goal.scorerName}</strong>${goal.assistName ? ` (assist: ${goal.assistName})` : ''}
                     <button class="incremental-btn" onclick="removeGoal('A', ${goal.time})">×</button>`;
                teamAGoalsEl.appendChild(goalDiv);
            });
            
            teamB.goals.forEach(goal => {
                const goalDiv = document.createElement('div');
                goalDiv.className = 'goal-item';
                goalDiv.innerHTML = 
                    `<strong>${goal.scorerName}</strong>${goal.assistName ? ` (assist: ${goal.assistName})` : ''}
                     <button class="incremental-btn" onclick="removeGoal('B', ${goal.time})">×</button>`;
                teamBGoalsEl.appendChild(goalDiv);
            });
        }
        
        function removeGoal(team, timestamp) {
            const teamObj = team === 'A' ? teamA : teamB;
            
            // Find and remove the goal
            const index = teamObj.goals.findIndex(g => g.time === timestamp);
            if (index !== -1) {
                teamObj.goals.splice(index, 1);
                
                // Update score input
                const scoreInput = document.getElementById(`team${team}Score`);
                scoreInput.value = Math.max(0, parseInt(scoreInput.value || 0) - 1);
                
                // Update goals display
                renderGoals();
            }
        }
        
        function updateGoalSelectors() {
            const teamAScorer = document.getElementById('teamAScorer');
            const teamAAssist = document.getElementById('teamAAssist');
            const teamBScorer = document.getElementById('teamBScorer');
            const teamBAssist = document.getElementById('teamBAssist');
            
            // Clear existing options except the default
            teamAScorer.innerHTML = '<option value="">Goal scorer...</option>';
            teamAAssist.innerHTML = '<option value="">Assist (optional)...</option>';
            teamBScorer.innerHTML = '<option value="">Goal scorer...</option>';
            teamBAssist.innerHTML = '<option value="">Assist (optional)...</option>';
            
            // Add all Team A players
            [...teamA.starters, ...teamA.reserves].forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = player.name;
                teamAScorer.appendChild(option);
                
                const assistOption = option.cloneNode(true);
                teamAAssist.appendChild(assistOption);
            });
            
            // Add all Team B players
            [...teamB.starters, ...teamB.reserves].forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = player.name;
                teamBScorer.appendChild(option);
                
                const assistOption = option.cloneNode(true);
                teamBAssist.appendChild(assistOption);
            });
        }
        
        function recordMatch() {
            if (teamA.starters.length === 0 || teamB.starters.length === 0) {
                return alert('Please create teams before recording a match');
            }
            
            const teamAScore = parseInt(document.getElementById('teamAScore').value) || 0;
            const teamBScore = parseInt(document.getElementById('teamBScore').value) || 0;
            
            // Validate goal count matches score
            if (teamA.goals.length !== teamAScore || teamB.goals.length !== teamBScore) {
                if (!confirm('The number of recorded goals doesn\'t match the score. Continue anyway?')) {
                    return;
                }
            }
            
            // Create match object
            const match = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                teamA: {
                    starters: teamA.starters.map(p => p.id),
                    reserves: teamA.reserves.map(p => p.id),
                    score: teamAScore,
                    goals: teamA.goals
                },
                teamB: {
                    starters: teamB.starters.map(p => p.id),
                    reserves: teamB.reserves.map(p => p.id),
                    score: teamBScore,
                    goals: teamB.goals
                }
            };
            
            // Update player statistics
            const allTeamPlayers = [...teamA.starters, ...teamA.reserves, ...teamB.starters, ...teamB.reserves];
            
            allTeamPlayers.forEach(player => {
                const playerIndex = allTeamPlayers.findIndex(p => p.id === player.id);
                
                // Only update once per player
                if (playerIndex === allTeamPlayers.indexOf(player)) {
                    // Update attendance
                    player.attendance = (player.attendance || 0) + 1;
                    player.matches = (player.matches || 0) + 1;
                    
                    // Update win/loss/draw
                    const isTeamA = teamA.starters.includes(player) || teamA.reserves.includes(player);
                    
                    if (teamAScore > teamBScore) {
                        if (isTeamA) player.wins = (player.wins || 0) + 1;
                        else player.losses = (player.losses || 0) + 1;
                    } else if (teamBScore > teamAScore) {
                        if (isTeamA) player.losses = (player.losses || 0) + 1;
                        else player.wins = (player.wins || 0) + 1;
                    } else {
                        player.draws = (player.draws || 0) + 1;
                    }
                }
            });
            
            // Update goals and assists for each player
            const allGoals = [...teamA.goals, ...teamB.goals];
            allGoals.forEach(goal => {
                // Update scorer
                const scorer = allPlayers.find(p => p.id === goal.scorer);
                if (scorer) {
                    scorer.goals = (scorer.goals || 0) + 1;
                }
                
                // Update assist provider if any
                if (goal.assist) {
                    const assistant = allPlayers.find(p => p.id === goal.assist);
                    if (assistant) {
                        assistant.assists = (assistant.assists || 0) + 1;
                    }
                }
            });
            
            // Save match to history
            matchHistory.push(match);
            saveMatchesToStorage();
            savePlayersToStorage();
            
            alert('Match recorded successfully!');
            renderMatchHistory();
            renderPlayerList();
            resetTeams();
        }
        
        function renderMatchHistory() {
            matchHistoryEl.innerHTML = '';
            
            if (matchHistory.length === 0) {
                matchHistoryEl.innerHTML = '<p>No matches recorded yet.</p>';
                return;
            }
            
            // Sort by date, newest first
            const sortedMatches = [...matchHistory].reverse();
            
            sortedMatches.forEach(match => {
                const matchEl = document.createElement('div');
                matchEl.className = 'match-item';
                
                // Get player names for display
                const teamAStarterNames = getPlayerNamesById(match.teamA.starters);
                const teamBStarterNames = getPlayerNamesById(match.teamB.starters);
                
                // Create goals summary
                let teamAGoalsSummary = '';
                let teamBGoalsSummary = '';
                
                if (match.teamA.goals && match.teamA.goals.length > 0) {
                    teamAGoalsSummary = '<div><strong>Team A Goals:</strong> ' + 
                        match.teamA.goals.map(g => 
                            `${g.scorerName}${g.assistName ? ` (assist: ${g.assistName})` : ''}`
                        ).join(', ') + '</div>';
                }
                
                if (match.teamB.goals && match.teamB.goals.length > 0) {
                    teamBGoalsSummary = '<div><strong>Team B Goals:</strong> ' + 
                        match.teamB.goals.map(g => 
                            `${g.scorerName}${g.assistName ? ` (assist: ${g.assistName})` : ''}`
                        ).join(', ') + '</div>';
                }
                
                matchEl.innerHTML = `
                    <div><strong>Date:</strong> ${match.date}</div>
                    <div class="score">Team A ${match.teamA.score} - ${match.teamB.score} Team B</div>
                    <div><strong>Team A:</strong> ${teamAStarterNames.join(', ')}</div>
                    <div><strong>Team B:</strong> ${teamBStarterNames.join(', ')}</div>
                    ${teamAGoalsSummary}
                    ${teamBGoalsSummary}
                `;
                
                matchHistoryEl.appendChild(matchEl);
            });
        }
        
        function renderPlayerStats() {
            playerStatsEl.innerHTML = '';
            
            const searchTerm = searchStatsEl.value.toLowerCase();
            let filteredPlayers = allPlayers.filter(p => 
                p.name.toLowerCase().includes(searchTerm)
            );
            
            // Sort by matches played
            filteredPlayers.sort((a, b) => b.matches - a.matches);
            
            filteredPlayers.forEach(player => {
                if (player.matches > 0) {
                    const winRate = player.matches > 0 
                        ? ((player.wins / player.matches) * 100).toFixed(1) 
                        : '0.0';
                    
                    const playerStatsEl = document.createElement('div');
                    playerStatsEl.className = 'match-item';
                    playerStatsEl.innerHTML = `
                        <h3>${player.name}</h3>
                        <div><strong>Skill Rating:</strong> ${player.rating}/10</div>
                        <div><strong>Matches Played:</strong> ${player.matches}</div>
                        <div><strong>Record:</strong> ${player.wins}W - ${player.losses}L - ${player.draws}D</div>
                        <div><strong>Win Rate:</strong> ${winRate}%</div>
                        <div><strong>Goals:</strong> ${player.goals || 0}</div>
                        <div><strong>Assists:</strong> ${player.assists || 0}</div>
                    `;
                    
                    playerStats.appendChild(playerStatsEl);
                }
            });
            
            if (playerStats.children.length === 0) {
                playerStats.innerHTML = '<p>No player statistics available.</p>';
            }
        }
        
        function getPlayerNamesById(idArray) {
            return idArray.map(id => {
                const player = allPlayers.find(p => p.id === id);
                return player ? player.name : 'Unknown Player';
            });
        }
        
        function formatPosition(position) {
            if (position === 'field') return 'Field Player';
            if (position === 'goalkeeper') return 'Goalkeeper';
            if (position === 'both') return 'Field/GK';
            return position;
        }
        
        function updatePlayerCount() {
            playerCountEl.textContent = allPlayers.length;
        }
        
        function savePlayersToStorage() {
            localStorage.setItem('footballPlayers', JSON.stringify(allPlayers));
        }
        
        function saveMatchesToStorage() {
            localStorage.setItem('matchHistory', JSON.stringify(matchHistory));
        }
        
        function saveToFile() {
            const data = {
                players: allPlayers,
                matches: matchHistory
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'football_team_data.json';
            a.click();
        }
        
        function loadFromFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('This will replace your current player data. Continue?')) {
                        if (data.players) {
                            allPlayers = data.players;
                        }
                        
                        if (data.matches) {
                            matchHistory = data.matches;
                        }
                        
                        savePlayersToStorage();
                        saveMatchesToStorage();
                        renderPlayerList();
                        updatePlayerCount();
                        renderMatchHistory();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function generateRandomComparison() {
            // Need at least 2 players to compare
            if (allPlayers.length < 2) {
                return alert('You need at least 2 players to compare.');
            }
            
            // Select two random players
            const playerIndices = getRandomPlayerIndices(2);
            const player1 = allPlayers[playerIndices[0]];
            const player2 = allPlayers[playerIndices[1]];
            
            renderComparison(player1, player2);
        }
        
        function compareLastMatchPlayers() {
            // Check if we have any matches
            if (matchHistory.length === 0) {
                return alert('No match history available. Play a match first.');
            }
            
            // Get the last match
            const lastMatch = matchHistory[matchHistory.length - 1];
            
            // Get all player IDs from the match
            const playerIds = [
                ...lastMatch.teamA.starters,
                ...lastMatch.teamA.reserves,
                ...lastMatch.teamB.starters,
                ...lastMatch.teamB.reserves
            ];
            
            // Remove duplicates
            const uniqueIds = [...new Set(playerIds)];
            
            // Need at least 2 players to compare
            if (uniqueIds.length < 2) {
                return alert('Not enough players in the last match to compare.');
            }
            
            // Select two random players from the match
            const randomIndices = getRandomIndices(2, uniqueIds.length);
            const player1 = allPlayers.find(p => p.id === uniqueIds[randomIndices[0]]);
            const player2 = allPlayers.find(p => p.id === uniqueIds[randomIndices[1]]);
            
            if (!player1 || !player2) {
                return alert('Error finding players from the last match.');
            }
            
            renderComparison(player1, player2);
        }
        
        function renderComparison(player1, player2) {
            // Create comparison card
            comparisonContainerEl.innerHTML = `
                <div class="comparison-card">
                    <div class="player-compare left" id="player1">
                        <div class="player-name">${player1.name}</div>
                        <div class="player-stats">
                            <div>Rating: ${player1.rating}/10</div>
                            <div>Position: ${formatPosition(player1.position)}</div>
                            <div>Matches: ${player1.matches || 0}</div>
                            <div>Win Rate: ${getWinRate(player1)}%</div>
                            <div>Goals: ${player1.goals || 0}</div>
                            <div>Assists: ${player1.assists || 0}</div>
                        </div>
                    </div>
                    
                    <div class="comparison-buttons">
                        <div>Who performed better?</div>
                        <button onclick="votePlayer(${player1.id}, ${player2.id})">← ${player1.name}</button>
                        <button onclick="voteDraw(${player1.id}, ${player2.id})">Draw</button>
                        <button onclick="votePlayer(${player2.id}, ${player1.id})">→ ${player2.name}</button>
                    </div>
                    
                    <div class="player-compare right" id="player2">
                        <div class="player-name">${player2.name}</div>
                        <div class="player-stats">
                            <div>Rating: ${player2.rating}/10</div>
                            <div>Position: ${formatPosition(player2.position)}</div>
                            <div>Matches: ${player2.matches || 0}</div>
                            <div>Win Rate: ${getWinRate(player2)}%</div>
                            <div>Goals: ${player2.goals || 0}</div>
                            <div>Assists: ${player2.assists || 0}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function votePlayer(winnerId, loserId) {
            const winner = allPlayers.find(p => p.id === winnerId);
            const loser = allPlayers.find(p => p.id === loserId);
            
            if (!winner || !loser) {
                return alert('Error finding players.');
            }
            
            // Calculate Elo rating change
            const kFactor = 32; // This determines how much ratings change (standard in chess)
            const expectedScore = 1 / (1 + Math.pow(10, (loser.rating - winner.rating) / 400));
            const ratingChange = Math.round(kFactor * (1 - expectedScore));
            
            // Update ratings (capped between 1-10)
            winner.rating = Math.min(10, Math.max(1, winner.rating + ratingChange / 10));
            loser.rating = Math.min(10, Math.max(1, loser.rating - ratingChange / 10));
            
            // Save to storage
            savePlayersToStorage();
            
            // Show feedback
            alert(`${winner.name}'s rating increased by ${(ratingChange / 10).toFixed(1)} to ${winner.rating.toFixed(1)}\n${loser.name}'s rating decreased by ${(ratingChange / 10).toFixed(1)} to ${loser.rating.toFixed(1)}`);
            
            // Generate a new comparison
            generateRandomComparison();
        }
        
        function voteDraw(player1Id, player2Id) {
            // In a draw, ratings stay roughly the same with minimal adjustment
            const player1 = allPlayers.find(p => p.id === player1Id);
            const player2 = allPlayers.find(p => p.id === player2Id);
            
            if (!player1 || !player2) {
                return alert('Error finding players.');
            }
            
            // For draws, we make very small adjustments to converge ratings
            if (player1.rating > player2.rating) {
                player1.rating = Math.max(1, player1.rating - 0.1);
                player2.rating = Math.min(10, player2.rating + 0.1);
            } else if (player2.rating > player1.rating) {
                player2.rating = Math.max(1, player2.rating - 0.1);
                player1.rating = Math.min(10, player1.rating + 0.1);
            }
            
            // Save to storage
            savePlayersToStorage();
            
            // Show feedback
            alert(`Draw recorded. Ratings adjusted slightly.`);
            
            // Generate a new comparison
            generateRandomComparison();
        }
        
        // Helper functions for comparison system
        function getRandomPlayerIndices(count) {
            return getRandomIndices(count, allPlayers.length);
        }
        
        function getRandomIndices(count, max) {
            const indices = [];
            while (indices.length < count) {
                const randomIndex = Math.floor(Math.random() * max);
                if (!indices.includes(randomIndex)) {
                    indices.push(randomIndex);
                }
            }
            return indices;
        }
        
        function getWinRate(player) {
            if (!player.matches || player.matches === 0) return "0.0";
            return ((player.wins || 0) / player.matches * 100).toFixed(1);
        }
        
        function simulateSendInvites() {
            const playersNeeded = parseInt(document.getElementById('playersNeeded').value) || 14;
            const priorityType = document.getElementById('invitePriority').value;
            const message = document.getElementById('invitationMessage').value;
            
            // Sort players based on priority
            let sortedPlayers = [...allPlayers];
            
            if (priorityType === 'attendance') {
                sortedPlayers.sort((a, b) => (b.attendance || 0) - (a.attendance || 0));
            } else if (priorityType === 'rating') {
                sortedPlayers.sort((a, b) => b.rating - a.rating);
            } else if (priorityType === 'hybrid') {
                sortedPlayers.sort((a, b) => {
                    const aScore = (a.attendance || 0) * 0.6 + a.rating * 0.4;
                    const bScore = (b.attendance || 0) * 0.6 + b.rating * 0.4;
                    return bScore - aScore;
                });
            }
            
            // Get top players
            const invitees = sortedPlayers.slice(0, playersNeeded);
            
            // Show results
            const resultsEl = document.getElementById('invitationResults');
            resultsEl.style.display = 'block';
            
            const inviteeListEl = document.getElementById('inviteeList');
            inviteeListEl.innerHTML = '';
            
            invitees.forEach((player, index) => {
                const inviteeEl = document.createElement('div');
                inviteeEl.className = 'invitee';
                inviteeEl.innerHTML = `
                    ${index + 1}. <strong>${player.name}</strong> - 
                    Rating: ${player.rating}/10, 
                    Attendance: ${player.attendance || 0} games
                    <span style="color: green">[Message sent]</span>
                `;
                inviteeListEl.appendChild(inviteeEl);
            });
            
            alert(`Simulated sending SMS to ${invitees.length} players based on ${priorityType} priority.`);
        }
    </script>
</body>
</html>